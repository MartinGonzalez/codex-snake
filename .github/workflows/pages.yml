name: Pages (main + PR previews)

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]

permissions:
  contents: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.pull_request.state == 'open'
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Prepare site content
        run: |
          set -euo pipefail
          mkdir -p _site
          rsync -av --delete \
            --exclude '.git' \
            --exclude '.github' \
            --exclude 'tests' \
            --exclude 'node_modules' \
            ./ _site/

      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages
        continue-on-error: true

      - name: Initialize gh-pages branch if missing
        run: |
          set -euo pipefail
          if [ ! -d gh-pages/.git ]; then
            mkdir -p gh-pages
            cd gh-pages
            git init
            git checkout -b gh-pages
            git remote add origin "https://github.com/${GITHUB_REPOSITORY}.git"
          fi

      - name: Copy content into destination
        run: |
          set -euo pipefail
          DEST=""
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            DEST="pr/${{ github.event.pull_request.number }}"
          else
            DEST="."
          fi

          mkdir -p "gh-pages/${DEST}"
          rsync -av --delete _site/ "gh-pages/${DEST}/"

          # Add a simple index for PR previews.
          if [ "${GITHUB_EVENT_NAME}" = "pull_request" ]; then
            mkdir -p gh-pages/pr
            cat > gh-pages/pr/index.html <<'EOF'
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PR Previews</title>
    <style>body{font-family:system-ui,Arial,sans-serif;max-width:900px;margin:32px auto;padding:0 16px} code{background:#f2f2f2;padding:2px 6px;border-radius:6px}</style>
  </head>
  <body>
    <h1>PR previews</h1>
    <p>Open a preview by visiting <code>/pr/&lt;number&gt;/</code>.</p>
  </body>
</html>
EOF
          fi

      - name: Commit + push
        run: |
          set -euo pipefail
          cd gh-pages
          touch .nojekyll
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to publish."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "pages: publish ${GITHUB_EVENT_NAME} ${GITHUB_SHA}"
          git push "https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git" gh-pages

  cleanup:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: Remove closed PR preview
        run: |
          set -euo pipefail
          PR_NUM=${{ github.event.pull_request.number }}
          rm -rf "pr/${PR_NUM}" || true

      - name: Commit + push cleanup
        run: |
          set -euo pipefail
          git add -A
          if git diff --cached --quiet; then
            echo "Nothing to clean up."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "pages: cleanup pr/${{ github.event.pull_request.number }}"
          git push
